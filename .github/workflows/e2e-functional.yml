name: Electron Playwright Tests

on:
  workflow_dispatch:
    inputs:
      version_name:
        type: string
        description: "Desktop Version. It can be a branch name or a tag or a commit SHA"
        required: true
      instance_details:
        type: string
        description: "JSON array of platform details"
        required: false
      MM_TEST_USER_NAME:
        description: "The admin username of the test instance"
        required: false
        type: string
      MM_TEST_PASSWORD:
        description: "The admin password of the test instance"
        required: false
        type: string
      MM_SERVER_VERSION:
        type: string
        description: "The server version to test against"
        required: true
      nightly:
        type: boolean
        description: "True if this is nightly build"
        required: false
        default: false

jobs:
  prepare-matrix:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.instance_details != '' }}
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.generate.outputs.platforms }}
    steps:
      - id: generate
        run: |
          echo "platforms=$(echo '${{ inputs.instance_details }}' | jq -c)" >> $GITHUB_OUTPUT

  update-initial-status:
    name: Update initial status
    needs: prepare-matrix
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Update initial status for all platforms
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ github.token }}
          script: |
            const { updateInitialStatus } = require('./e2e/utils/github-actions.js');
            const platforms = ${{ needs.prepare-matrix.outputs.platforms }};
            await updateInitialStatus({ github, context, platforms });

  e2e-tests:
    needs: 
      - prepare-matrix
      - update-initial-status
    name: ${{ matrix.platform }}
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.platforms) }}
      fail-fast: false
    uses: ./.github/workflows/e2e-functional-template.yml
    with:
      runs-on: ${{ matrix.runner }}
      DESKTOP_VERSION: ${{ inputs.version_name }}
      MM_TEST_SERVER_URL: ${{ matrix.url }}
      MM_SERVER_VERSION: ${{ inputs.MM_SERVER_VERSION }}
      MM_TEST_USER_NAME: ${{ inputs.MM_TEST_USER_NAME }}
      MM_TEST_PASSWORD: ${{ inputs.MM_TEST_PASSWORD }}
      TYPE: ${{ startsWith(github.ref_name, 'release-') && 'RELEASE' || (github.ref_name == 'master' && 'MASTER') || 'PR' }}
      nightly: ${{ inputs.nightly }}
    secrets: inherit

  update-final-status:
    name: Update final status
    runs-on: ubuntu-22.04
    needs:
      - prepare-matrix
      - e2e-tests
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Update final status for all platforms
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ github.token }}
          script: |
            const { updateFinalStatus } = require('./e2e/utils/github-actions.js');
            const platforms = ${{ needs.prepare-matrix.outputs.platforms }};
            const outputs = ${{ toJSON(needs.e2e-tests.outputs) }};
            await updateFinalStatus({ github, context, platforms, outputs });

  remove-e2e-label:
    runs-on: ubuntu-22.04
    needs: [update-final-status]
    if: always()
    permissions:
      actions: read
      issues: write
      pull-requests: read
    steps:
      - name: Remove E2E/Run label when triggered via Matterwick
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        continue-on-error: true
        with:
          script: |
            try {
              // Get the current run to check if it was triggered by workflow_dispatch
              const run = await github.rest.actions.getWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.runId
              });

              // Only remove the label if this was triggered via workflow_dispatch (Matterwick)
              if (run.data.event !== 'workflow_dispatch') {
                console.log('Label removal skipped - workflow run is not triggered by workflow_dispatch (Matterwick)');
                return;
              }

              // Try to find associated PR
              let prNumber = null;

              // First try: check run.data.pull_requests (reliable for pull_request events)
              if (run.data.pull_requests && run.data.pull_requests.length > 0) {
                prNumber = run.data.pull_requests[0].number;
              } else {
                // Second try: query PRs by head branch (more reliable for workflow_dispatch)
                const branchName = run.data.head_branch;
                if (branchName) {
                  // Use the actual head repository owner (supports fork PRs)
                  const headOwner = run.data.head_repository?.owner?.login || context.repo.owner;
                  const prs = await github.rest.pulls.list({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'open',
                    head: `${headOwner}:${branchName}`
                  });
                  if (prs.data && prs.data.length > 0) {
                    prNumber = prs.data[0].number;
                  }
                }
              }

              if (prNumber) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: 'E2E/Run'
                });
              } else {
                console.log('Label removal skipped - could not find associated PR');
              }
            } catch (error) {
              if (error && error.status === 404) {
                console.log('Label removal skipped - label "E2E/Run" is not present on the associated PR (404).');
              } else if (error && error.status === 403) {
                console.log('Label removal failed - insufficient permissions to modify labels on the associated PR (403).');
              } else {
                console.log(`Label removal failed due to an unexpected error: status=${error && error.status}, message=${error && error.message}`);
              }
            }
